import 'package:supabase_flutter/supabase_flutter.dart';
import 'package:alson_education/models/user.dart' as app_user;
import 'package:alson_education/models/content.dart';
import 'package:alson_education/models/message.dart';

class ApiService {
  final SupabaseClient supabase = Supabase.instance.client;

  // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Supabase
  Future<bool> checkSupabaseConnection() async {
    try {
      final result = await supabase.from('users').select('count').limit(1);
      return result != null;
    } catch (e) {
      print('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase: $e');
      return false;
    }
  }

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø¹Ø¯Ù„
  Future<app_user.AppUser?> login(String code, String password) async {
    try {
      print('ğŸ” Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙƒÙˆØ¯: $code');

      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙƒÙˆØ¯ ÙÙ‚Ø· Ø£ÙˆÙ„Ø§Ù‹
      final userResponse = await supabase
          .from('users')
          .select()
          .eq('code', code)
          .maybeSingle();

      if (userResponse == null) {
        throw Exception('ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ­ÙŠØ­');
      }

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
      if (userResponse['password'] != password) {
        throw Exception('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
      }

      print('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­: ${userResponse['username']}');
      return app_user.AppUser.fromJson(userResponse);

    } catch (e) {
      print('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: $e');
      if (e is PostgrestException) {
        throw Exception('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e.message}');
      } else {
        rethrow;
      }
    }
  }

  // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
  Future<List<Content>> getContent() async {
    try {
      print('ğŸ“¦ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...');
      
      final response = await supabase
          .from('content')
          .select()
          .order('upload_date', ascending: false);

      print('âœ… ØªÙ… Ø¬Ù„Ø¨ ${response.length} Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰');
      return response.map((item) => Content.fromJson(item)).toList();

    } catch (e) {
      print('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: $e');
      throw Exception('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: $e');
    }
  }

  // Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
  Future<List<Message>> getChatMessages() async {
    try {
      print('ğŸ’¬ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...');
      
      final response = await supabase
          .from('messages')
          .select()
          .order('timestamp', ascending: true);

      print('âœ… ØªÙ… Ø¬Ù„Ø¨ ${response.length} Ø±Ø³Ø§Ù„Ø©');
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„join
      final messagesWithUsers = <Message>[];
      
      for (var message in response) {
        try {
          // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø¬Ø¯ÙˆÙ„ users
          final userResponse = await supabase
              .from('users')
              .select('username')
              .eq('code', message['sender_id'])
              .maybeSingle();

          final username = userResponse?['username'] ?? 'Ù…Ø³ØªØ®Ø¯Ù…';
          
          messagesWithUsers.add(Message.fromJson({
            'id': message['id'],
            'content': message['content'],
            'sender_id': message['sender_id'],
            'username': username,
            'department': message['department'] ?? '',
            'division': message['division'] ?? '',
            'timestamp': message['timestamp'],
          }));
        } catch (e) {
          // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
          messagesWithUsers.add(Message.fromJson({
            'id': message['id'],
            'content': message['content'],
            'sender_id': message['sender_id'],
            'username': 'Ù…Ø³ØªØ®Ø¯Ù…',
            'department': message['department'] ?? '',
            'division': message['division'] ?? '',
            'timestamp': message['timestamp'],
          }));
        }
      }
      
      return messagesWithUsers;

    } catch (e) {
      print('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: $e');
      throw Exception('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: $e');
    }
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
  Future<bool> sendMessage({
    required String senderId,
    required String content,
  }) async {
    try {
      print('ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©...');
      
      await supabase.from('messages').insert({
        'content': content,
        'sender_id': senderId,
        'department': '',
        'division': '',
        'timestamp': DateTime.now().toIso8601String(),
      });

      print('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
      return true;

    } catch (e) {
      print('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: $e');
      throw Exception('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: $e');
    }
  }

  // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  Future<List<app_user.AppUser>> getUsers() async {
    try {
      print('ğŸ‘¥ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...');
      
      final response = await supabase
          .from('users')
          .select()
          .order('username', ascending: true);

      print('âœ… ØªÙ… Ø¬Ù„Ø¨ ${response.length} Ù…Ø³ØªØ®Ø¯Ù…');
      return response.map((item) => app_user.AppUser.fromJson(item)).toList();

    } catch (e) {
      print('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: $e');
      throw Exception('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: $e');
    }
  }

  // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…
  Future<bool> addUser({
    required String code,
    required String username,
    required String role,
    required String password,
  }) async {
    try {
      print('â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯: $username');
      
      await supabase.from('users').insert({
        'code': code,
        'username': username,
        'department': '',
        'division': '',
        'role': role,
        'password': password,
      });

      print('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
      return true;

    } catch (e) {
      print('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: $e');
      throw Exception('ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: $e');
    }
  }

  // Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…
  Future<bool> deleteUser(String code) async {
    try {
      print('ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: $code');
      
      await supabase
          .from('users')
          .delete()
          .eq('code', code);

      print('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
      return true;

    } catch (e) {
      print('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: $e');
      throw Exception('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: $e');
    }
  }

  // Ø±ÙØ¹ Ù…Ø­ØªÙˆÙ‰ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø­Ø³Ù†
  Future<bool> uploadContent({
    required String title,
    required String fileUrl,
    required String uploadedBy,
    required String description,
  }) async {
    try {
      print('ğŸ“¤ Ø±ÙØ¹ Ù…Ø­ØªÙˆÙ‰: $title');
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
      if (!_isValidUrl(fileUrl)) {
        throw Exception('Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­');
      }

      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯
      final userResponse = await supabase
          .from('users')
          .select('code')
          .eq('username', uploadedBy)
          .maybeSingle();

      String uploadedByCode = userResponse?['code'] ?? uploadedBy;

      // Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
      final response = await supabase.from('content').insert({
        'title': title,
        'file_path': fileUrl,
        'file_type': fileUrl.split('.').last.toLowerCase(),
        'file_size': '0',
        'uploaded_by': uploadedByCode,
        'department': '',
        'division': '',
        'description': description,
        'upload_date': DateTime.now().toIso8601String(),
      }).select();

      if (response != null && response.isNotEmpty) {
        print('âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­');
        return true;
      } else {
        throw Exception('ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      }

    } catch (e) {
      print('âŒ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: $e');
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ù…Ø­Ø¯Ø¯Ø©
      if (e is PostgrestException) {
        if (e.code == '23503') {
          throw Exception('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… ØµØ­ÙŠØ­');
        } else if (e.code == '23505') {
          throw Exception('Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
        } else {
          throw Exception('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${e.message}');
        }
      }
      
      throw Exception('ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ${e.toString()}');
    }
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
  bool _isValidUrl(String url) {
    try {
      final uri = Uri.parse(url);
      return uri.isAbsolute && (uri.scheme == 'http' || uri.scheme == 'https');
    } catch (e) {
      return false;
    }
  }

  // Ø­Ø°Ù Ù…Ø­ØªÙˆÙ‰
  Future<bool> deleteContent(String id) async {
    try {
      print('ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰: $id');
      
      await supabase
          .from('content')
          .delete()
          .eq('id', id);

      print('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­');
      return true;

    } catch (e) {
      print('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰: $e');
      throw Exception('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰: $e');
    }
  }
}